<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° PUNK WEBSOCKET DEMO - NO AUTH</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            border: 2px solid #0f0;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            background: #001100;
        }
        .header h1 {
            font-size: 48px;
            text-transform: uppercase;
            letter-spacing: -3px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 2px solid #0f0;
            padding: 20px;
            background: #000a00;
        }
        .panel-title {
            font-size: 24px;
            text-transform: uppercase;
            border-bottom: 1px solid #0f0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        input, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #0f0;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin-bottom: 15px;
        }
        input:focus, textarea:focus {
            outline: none;
            background: #002200;
        }
        button {
            width: 100%;
            padding: 20px;
            border: 2px solid #0f0;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0f0;
            color: #000;
        }
        button:active {
            background: #008800;
        }
        .log {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #0f0;
            padding: 15px;
            background: #000;
            font-size: 14px;
        }
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #004400;
        }
        .log-entry.success {
            color: #00ff00;
        }
        .log-entry.error {
            color: #ff0000;
        }
        .status {
            padding: 15px;
            border: 2px solid #0f0;
            margin-bottom: 20px;
            text-align: center;
            font-size: 20px;
            text-transform: uppercase;
        }
        .status.ready {
            background: #001100;
            color: #00ff00;
        }
        .message-box {
            border: 2px solid #0f0;
            padding: 15px;
            margin-bottom: 10px;
            background: #000a00;
        }
        .message-box .user {
            color: #00ffff;
            font-weight: bold;
        }
        .message-box .text {
            color: #0f0;
        }
        .message-box .time {
            color: #006600;
            font-size: 12px;
        }
        .counter {
            font-size: 72px;
            text-align: center;
            line-height: 1;
        }
        .counter-label {
            text-align: center;
            font-size: 14px;
            text-transform: uppercase;
            margin-top: 10px;
        }
        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; }
            .header h1 { font-size: 32px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° PUNK WEBSOCKET DEMO</h1>
        <p>NO AUTH // PUBLIC COLLECTION // REAL-TIME</p>
    </div>

    <div class="status ready">
        ‚úÖ COLLECTION: demo_chat // READ: PUBLIC // WRITE: PUBLIC
    </div>

    <div class="container">
        <!-- LEFT PANEL: ACTIONS -->
        <div class="panel">
            <div class="panel-title">/// SEND MESSAGE</div>

            <input type="text" id="username" placeholder="USERNAME" value="Anonymous">
            <textarea id="message" rows="4" placeholder="YOUR MESSAGE..."></textarea>

            <button onclick="sendMessage()">
                [ SEND TO CANISTER ]
            </button>

            <button onclick="sendBatch()">
                [ SEND x5 FAST ]
            </button>

            <button onclick="clearMessages()">
                [ CLEAR MESSAGES ]
            </button>

            <div style="margin-top: 30px;">
                <div class="counter" id="counter">0</div>
                <div class="counter-label">MESSAGES SENT</div>
            </div>
        </div>

        <!-- RIGHT PANEL: LOGS & MESSAGES -->
        <div class="panel">
            <div class="panel-title">/// ACTIVITY LOG</div>
            <div class="log" id="log">
                <div class="log-entry success">[SYSTEM] PUNK DEMO INITIALIZED</div>
                <div class="log-entry success">[SYSTEM] CANISTER: uzt4z-lp777-77774-qaabq-cai</div>
                <div class="log-entry success">[SYSTEM] COLLECTION: demo_chat (PUBLIC)</div>
                <div class="log-entry success">[SYSTEM] READY TO SEND!</div>
            </div>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <div class="panel-title">/// RECENT MESSAGES</div>
        <div id="messages">
            <div style="text-align: center; padding: 30px; color: #004400;">
                [ NO MESSAGES YET - SEND ABOVE ]
            </div>
        </div>
    </div>

    <script>
        const CANISTER_ID = 'uzt4z-lp777-77774-qaabq-cai';
        const AGENT_URL = 'http://127.0.0.1:4943';
        const COLLECTION = 'demo_chat';

        let messageCount = 0;
        let messages = [];

        function log(msg, type = 'normal') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${time}] ${msg}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        function addMessage(username, text) {
            messages.unshift({ username, text, time: Date.now() });
            if (messages.length > 10) messages.pop();

            const container = document.getElementById('messages');
            container.innerHTML = messages.map(m => `
                <div class="message-box">
                    <span class="user">${m.username}:</span>
                    <span class="text">${m.text}</span>
                    <br>
                    <span class="time">${new Date(m.time).toLocaleTimeString()}</span>
                </div>
            `).join('');
        }

        async function sendMessage() {
            const username = document.getElementById('username').value || 'Anonymous';
            const text = document.getElementById('message').value;

            if (!text.trim()) {
                log('‚ùå EMPTY MESSAGE!', 'error');
                return;
            }

            const key = `msg-${Date.now()}`;
            const data = {
                username,
                text,
                timestamp: Date.now()
            };

            log(`üì§ SENDING: ${text.substring(0, 30)}...`);

            try {
                // Call set_doc directly via HTTP
                const response = await fetch(`${AGENT_URL}/api/v2/canister/${CANISTER_ID}/call`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'set_doc',
                        args: [
                            { collection: COLLECTION },
                            { key: key },
                            { data: new TextEncoder().encode(JSON.stringify(data)) }
                        ]
                    })
                });

                messageCount++;
                document.getElementById('counter').textContent = messageCount;

                log(`‚úÖ SENT: ${text.substring(0, 30)}...`, 'success');
                addMessage(username, text);

                document.getElementById('message').value = '';
            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        async function sendBatch() {
            const username = document.getElementById('username').value || 'Anonymous';
            log(`üöÄ SENDING 5 MESSAGES FAST...`);

            for (let i = 0; i < 5; i++) {
                const key = `batch-${Date.now()}-${i}`;
                const data = {
                    username,
                    text: `Batch message #${i + 1} - ${new Date().toLocaleTimeString()}`,
                    timestamp: Date.now()
                };

                try {
                    await fetch(`${AGENT_URL}/api/v2/canister/${CANISTER_ID}/call`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            method: 'set_doc',
                            args: [
                                { collection: COLLECTION },
                                { key: key },
                                { data: new TextEncoder().encode(JSON.stringify(data)) }
                            ]
                        })
                    });

                    messageCount++;
                } catch (e) {
                    log(`‚ùå Batch ${i + 1} failed`, 'error');
                }

                await new Promise(r => setTimeout(r, 100));
            }

            document.getElementById('counter').textContent = messageCount;
            log(`‚úÖ BATCH COMPLETE: 5 messages sent`, 'success');
        }

        function clearMessages() {
            messages = [];
            document.getElementById('messages').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #004400;">
                    [ MESSAGES CLEARED ]
                </div>
            `;
            log('üóëÔ∏è MESSAGES CLEARED');
        }

        // Enter key to send
        document.getElementById('message').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        log('');
        log('üéÆ READY FOR DEMO - NO AUTH REQUIRED!', 'success');
        log('üíö Type a message and click SEND', 'success');
    </script>
</body>
</html>
