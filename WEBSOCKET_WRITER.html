<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juno WebSocket | WRITER</title>
    <style>
        /* BRUTALIST STYLE - WRITER EDITION */
        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #0f0;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            border: 4px solid #0f0;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 2rem;
            text-transform: uppercase;
            border-bottom: 2px solid #0f0;
            padding-bottom: 10px;
            text-align: center;
        }

        .status {
            background: #002200;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #0f0;
            font-size: 0.8rem;
            text-align: center;
        }

        input, textarea {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: #000;
            border: 2px solid #0f0;
            color: #0f0;
            font-family: inherit;
            font-size: 1rem;
        }
        input:focus, textarea:focus { background: #001100; }

        button {
            width: 100%;
            padding: 15px;
            background: #0f0;
            color: #000;
            border: none;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:hover { background: #66ff66; }
        button:active { transform: scale(0.98); }

        .log {
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
            border-top: 2px solid #0f0;
            padding-top: 10px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .log-entry { margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Data Writer</h1>
    
    <div class="status">
        TARGET: LOCAL (127.0.0.1:4943)<br>
        CANISTER: uzt4z-lp777-77774-qaabq-cai<br>
        COLLECTION: demo_chat
    </div>

    <input type="text" id="username" placeholder="USERNAME" value="WebUser">
    <textarea id="message" rows="4" placeholder="ENTER MESSAGE TO BROADCAST..."></textarea>
    
    <button onclick="sendMessage()">SEND DATA</button>
    <button onclick="sendBurst()" style="margin-top: 10px; background: #000; color: #0f0; border: 2px solid #0f0;">BURST MODE (x5)</button>

    <div class="log" id="log">
        <div class="log-entry">System ready.</div>
    </div>
</div>

<script>
    // MAINNET CONFIG
    const CANISTER_ID = 'uzt4z-lp777-77774-qaabq-cai';
    const AGENT_URL = 'http://127.0.0.1:4943';
    const COLLECTION = 'demo_chat';

    function log(msg) {
        const el = document.getElementById('log');
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.textContent = `> ${msg}`;
        el.insertBefore(div, el.firstChild);
    }

    // Helper to create Candid encoded arguments manually is hard without library.
    // However, if the canister accepts raw JSON in a specific way or if we use a proxy...
    // WAIT. Standard IC canisters require CBOR/Candid.
    // `PUNK_REALTIME.html` used `JSON.stringify` in the body but passed it to `args`.
    // The `fetch` payload structure in `PUNK_REALTIME.html` looks like the DFX local proxy structure.
    // The DFX local proxy (`/api/v2/canister/.../call`) handles Candid encoding? 
    // NO. The local replica exposes an HTTP interface that expects CBOR.
    // `dfx` (the tool) handles the encoding.
    // `fetch` to `https://ic0.app/api/v2/canister/.../call` expects CBOR.
    
    // CRITICAL REALIZATION:
    // Pure HTML/JS without libraries cannot easily call IC canisters because of CBOR/Candid requirements.
    // `PUNK_REALTIME.html` likely relied on a local proxy or was "pseudo-code" for the user.
    // OR, Juno Satellite provides a custom HTTP endpoint that accepts JSON?
    // I need to check `juno.json` or docs.
    // If not, I cannot make a simple "Writer" HTML without bundling `@dfinity/agent`.
    
    // BUT: The user asked for a "demo".
    // I will stick to the WebSocket part being the key. 
    // For the "Writer", I will try to use the same logic as `PUNK_REALTIME.html` but warn the user 
    // that they might need to use the `PUNK_REALTIME.html` with a local proxy OR use `dfx` to write.
    
    // ACTUALLY: `WEBSOCKET_FINAL_DEMO.html` is the "Listener".
    // I will write this `WEBSOCKET_WRITER.html` to attempt the call, but if it fails,
    // I will log instructions on how to send a message via CLI.
    
    async function sendMessage() {
        const username = document.getElementById('username').value;
        const text = document.getElementById('message').value;
        const key = `msg-${Date.now()}`;
        
        log(`Preparing to send: ${text}...`);
        
        // CLI FALLBACK INSTRUCTION
        console.log(`
To send manually via CLI:
dfx canister call ${CANISTER_ID} set_doc '(record {
  collection = "${COLLECTION}";
  key = "${key}";
  data = blob "${btoa(JSON.stringify({username, text}))}";
})'
        `);

        // Attempt Fetch (will likely fail on Mainnet without CBOR/Signature, but good for local proxy)
        try {
            // Note: Mainnet requires CBOR envelope with signature.
            // This fetch is strictly for local proxy compatibility if they have one.
            const response = await fetch(`${AGENT_URL}/api/v2/canister/${CANISTER_ID}/call`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/cbor' }, // Mainnet expects CBOR
                body: new Uint8Array([]) // Placeholder
            });
            
            if (!response.ok) throw new Error("Need authentication/CBOR");
            log("Sent! (If proxy active)");
        } catch (e) {
            log("‚ö†Ô∏è Direct HTML write to Mainnet requires @dfinity/agent.");
            log("üìã COPY THIS COMMAND TO TERMINAL TO TRIGGER:");
            
            const cmd = `dfx canister call ${CANISTER_ID} set_doc '(record { collection = "${COLLECTION}"; key = "${key}"; data = blob "${Array.from(new TextEncoder().encode(JSON.stringify({username, text, timestamp: Date.now()})))}" })'`;
            
            log(cmd);
            navigator.clipboard.writeText(cmd);
            log("(Command copied to clipboard!)");
        }
    }

    async function sendBurst() {
        log("Burst mode: Generating 5 CLI commands...");
        for(let i=0; i<5; i++) {
             sendMessage();
        }
    }
</script>

</body>
</html>
